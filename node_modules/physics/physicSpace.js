var PhysicSpace = function PhysicSpace() {
    this.bodies = [];
}

PhysicSpace.prototype = {
    addBody: function(body) {
        this.bodies.push(body);
    },

    removeBody: function(id) {
        var indexToRemove = -1;
        this.bodies.forEach(function(element, index, array) {
            if(element.id == id) {
                indexToRemove = index;
            }
        });
        if(indexToRemove >= 0) {
            this.bodies.splice(indexToRemove, 1);
        }
    },

    testCollisions: function(game) {
        var self = this;
        self.bodies.forEach(function(element, index, array) {
            var cur = element;
            var collided = false;
            var curBody = cur;
            self.bodies.forEach(function(element, index, array) {
                if(element != cur) {
                    //Test collision between 'cur' and 'element'
                    var body = element;
                    if((body.group == 'player' && curBody.group == 'platform') || (body.group == 'platform' && curBody.group == 'player')
                        || (body.group == 'player' && curBody.group == 'projectile') || (body.group == 'platform' && curBody.group == 'projectile')
                        || (body.group == 'projectile' && curBody.group == 'platform') || (body.group == 'platform' && curBody.group == 'projectile')
                        || (body.group == 'player' && curBody.group == 'player')
                        ) {

                        if((body.x <= curBody.x && curBody.x <= body.x+body.width)
                            || (body.x <= curBody.x+curBody.width && curBody.x+curBody.width <= body.x+body.width)) {
                            if((body.y <= curBody.y && curBody.y <= body.y+body.height)
                                || (body.y <= curBody.y+curBody.height && curBody.y+curBody.height <= body.y+body.height)) {

                                //Collision !
                                // /!\ A body can pass through another one if it is too speedy
                                var excessX = 0;
                                var excessY = 0;

                                //Math.min(right, left)
                                var excessXRight = curBody.x + curBody.width - body.x;
                                var excessXLeft = -(body.x + body.width - curBody.x);
                                if(Math.abs(excessXRight) < Math.abs(excessXLeft)){
                                    excessX = excessXRight;
                                } else {
                                    excessX = excessXLeft;
                                }

                                //Math.min(bottom, top)
                                var excessYBottom = curBody.y + curBody.height - body.y;
                                var excessYTop = -(body.y + body.height - curBody.y);
                                if(Math.abs(excessYBottom) < Math.abs(excessYTop)){
                                    excessY = excessYBottom;
                                } else {
                                    excessY = excessYTop;
                                }

                                if(Math.abs(excessX) < Math.abs(excessY)) {
                                    excessY = 0;
                                } else {
                                    excessX = 0;
                                }
                                curBody.onCollide(body, excessX, excessY, game);
                                body.onCollide(curBody, -excessX, -excessY, game);
                                collided = true;
                            }
                        }
                    }
                }
            });
            if(!collided) {
                if(curBody.getForce('reaction_bottom') != null) {
                    curBody.removeForce('reaction_bottom');
                }
                if(curBody.getForce('reaction_top') != null) {
                    curBody.removeForce('reaction_top');
                }
                if(curBody.getForce('reaction_right') != null) {
                    curBody.removeForce('reaction_right');
                }
                if(curBody.getForce('reaction_left') != null) {
                    curBody.removeForce('reaction_left');
                }
            }
        });
    }

}
module.exports = PhysicSpace;